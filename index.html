<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—É—á–∞–ª–∫–∞ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        #card-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        #card-image {
            width: 300px;
            height: 300px;
            object-fit: contain;
            display: block;
            margin: 10px auto;
        }
        .button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border-radius: 6px;
            cursor: pointer;
            touch-action: manipulation;
            transition: background-color 0.2s;
        }
        #range-container .button {
            background-color: #4b5563;
            color: white;
        }
        #range-container .button:hover {
            background-color: #374151;
        }
        #mode-button {
            background-color: #3b82f6;
            color: white;
        }
        #mode-button:hover {
            background-color: #2563eb;
        }
        #next-button {
            background-color: #1f2937;
            color: white;
        }
        #next-button:hover {
            background-color: #111827;
        }
        #auto-button {
            background-color: #22c55e;
            color: white;
        }
        #auto-button:hover {
            background-color: #16a34a;
        }
        #stats-button {
            background-color: #8b5cf6;
            color: white;
        }
        #stats-button:hover {
            background-color: #7c3aed;
        }
        #feedback {
            margin-top: 10px;
            font-weight: bold;
        }
        #range-container, #order-container, #delay-container {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #card-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 5rem;
            font-weight: bold;
            flex-wrap: wrap;
        }
        #mode-title {
            font-size: 2.5rem;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        #button-container {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        #options-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .option {
            padding: 8px 16px;
            background-color: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            user-select: none;
        }
        .option:hover {
            background-color: #d0d0d0;
        }
        .option.selected {
            background-color: #4CAF50;
            color: white;
        }
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
        }
        #modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 24px;
        }
        #stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #stats-table th, #stats-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #stats-table th {
            background-color: #f2f2f2;
        }
        @media (max-width: 600px) {
            #card-header {
                font-size: 3rem;
            }
            #mode-title {
                font-size: 1.8rem;
            }
            #range-container .button, #button-container .button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            #delay-container select {
                font-size: 0.9rem;
                padding: 5px;
            }
            .option {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            #card-image {
                width: 200px;
                height: 200px;
            }
            #modal-content {
                max-width: 95%;
            }
            #stats-table {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="card-container">
        <h1 id="mode-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h1>
        <div id="range-container">
            <label for="range-start">–û—Ç:</label>
            <input type="number" id="range-start" min="0" max="99" value="0">
            <label for="range-end">–î–æ:</label>
            <input type="number" id="range-end" min="0" max="99" value="9">
            <button class="button" onclick="updateRange()" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω">‚Üª</button>
        </div>
        <div id="order-container">
            <label><input type="radio" name="order" value="sequential" checked> –ü–æ –ø–æ—Ä—è–¥–∫—É</label>
            <label><input type="radio" name="order" value="random"> –°–ª—É—á–∞–π–Ω–æ</label>
        </div>
        <div id="delay-container">
            <label for="delay-select" id="delay-label">–í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ (—Å–µ–∫):</label>
            <select id="delay-select">
                <option value="500">0.5</option>
                <option value="1000">1</option>
                <option value="2000" selected>2</option>
            </select>
            <label for="answer-time-select" id="answer-time-label">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (—Å–µ–∫):</label>
            <select id="answer-time-select">
                <option value="1000">1</option>
                <option value="2000">2</option>
                <option value="3000">3</option>
                <option value="4000">4</option>
                <option value="5000" selected>5</option>
                <option value="6000">6</option>
                <option value="7000">7</option>
                <option value="8000">8</option>
                <option value="9000">9</option>
                <option value="10000">10</option>
            </select>
        </div>
        <div id="card-header">
            <span id="card-digit"></span>
            <span id="card-text"></span>
        </div>
        <img id="card-image" src="" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
        <div id="options-container"></div>
        <div id="feedback"></div>
        <div id="button-container">
            <button class="button" id="mode-button" onclick="toggleMode()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">üîÑ</button>
            <button class="button" id="next-button" onclick="nextCard()" title="–°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞">‚ñ∂‚ñ∂</button>
            <button class="button" id="auto-button" onclick="toggleAutoPlay()" title="–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ">‚ñ∂</button>
            <button class="button" id="stats-button" onclick="showStats()" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">üìä</button>
        </div>
    </div>
    <div id="modal">
        <div id="modal-content">
            <span id="modal-close" onclick="closeModal()">√ó</span>
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div id="current-stats">
                <h3>–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è</h3>
                <p id="stats-summary"></p>
                <canvas id="stats-chart" style="max-width: 100%; height: 200px;"></canvas>
            </div>
            <div id="history-stats">
                <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                <canvas id="history-chart" style="max-width: 100%; height: 200px;"></canvas>
                <table id="stats-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</th>
                            <th>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</th>
                            <th>–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ</th>
                            <th>–¢–æ—á–Ω–æ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
            <div style="margin-top: 10px;">
                <button class="button bg-purple-500 hover:bg-purple-600" onclick="exportStats()" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV">üì§</button>
                <button class="button bg-red-500 hover:bg-red-600" onclick="resetStats()" title="–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">üóëÔ∏è</button>
            </div>
        </div>
    </div>

    <script>
        let cards = { single_digits: [], double_digits: [] };
        let currentCardIndex = 0;
        let currentCards = [];
        let isMemorizationMode = true;
        let isAutoPlay = false;
        let autoPlayTimeout = null;
        let answerTimeout = null;
        let selectedLetter = null;
        let selectedWord = null;
        let stats = {
            correct: 0,
            incorrect: 0,
            timeout: 0,
            attempts: [],
            history: JSON.parse(localStorage.getItem('statsHistory')) || []
        };
        let streak = 0;

        // –ó–∞–≥—Ä—É–∑–∫–∞ JSON
        fetch('Flashcards/cards.json')
            .then(response => {
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å cards.json');
                return response.json();
            })
            .then(data => {
                cards = data;
                updateRange();
                updateStatsDisplay();
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:', error);
                document.getElementById('card-digit').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
            });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
        function updateRange() {
            const start = parseInt(document.getElementById('range-start').value);
            const end = parseInt(document.getElementById('range-end').value);
            const order = document.querySelector('input[name="order"]:checked').value;
            currentCards = [];

            if (start <= 9 && end <= 9) {
                currentCards = cards.single_digits.slice(start, end + 1);
            } else {
                const singleDigits = start <= 9 ? cards.single_digits.slice(start, Math.min(end + 1, 10)) : [];
                const doubleDigits = cards.double_digits.filter(card => {
                    const num = parseInt(card.number);
                    return num >= Math.max(start, 0) && num <= end;
                });
                currentCards = [...singleDigits, ...doubleDigits];
            }

            if (order === 'random') {
                currentCards = currentCards.sort(() => Math.random() - 0.5);
            }

            currentCardIndex = 0;
            stats.correct = 0;
            stats.incorrect = 0;
            stats.timeout = 0;
            stats.attempts = [];
            streak = 0;
            showCard();
            updateStatsDisplay();
            stopAutoPlay();
            stopAnswerTimer();
        }

        // –ü–æ–∫–∞–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
        function showCard() {
            if (currentCards.length === 0) {
                document.getElementById('card-digit').textContent = '–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ';
                document.getElementById('card-text').textContent = '';
                document.getElementById('card-image').src = '';
                document.getElementById('card-image').style.display = 'none';
                document.getElementById('options-container').innerHTML = '';
                document.getElementById('next-button').style.display = 'none';
                document.getElementById('auto-button').style.display = 'block';
                document.getElementById('feedback').textContent = '';
                document.getElementById('delay-label').style.display = isAutoPlay ? 'inline-block' : 'none';
                document.getElementById('delay-select').style.display = isAutoPlay ? 'inline-block' : 'none';
                document.getElementById('answer-time-label').style.display = 'none';
                document.getElementById('answer-time-select').style.display = 'none';
                return;
            }

            const card = currentCards[currentCardIndex];
            const isSingleDigit = 'digit' in card;
            document.getElementById('card-digit').textContent = isSingleDigit ? card.digit : card.number;
            document.getElementById('card-text').textContent = isMemorizationMode ? (isSingleDigit ? card.letter : card.word) : '';
            const imagePath = isMemorizationMode ? `images/${encodeURIComponent(card.image)}` : '';
            document.getElementById('card-image').src = imagePath;
            document.getElementById('card-image').style.display = isMemorizationMode ? 'block' : 'none';
            document.getElementById('next-button').style.display = isAutoPlay ? 'none' : 'block';
            document.getElementById('auto-button').style.display = 'block';
            document.getElementById('delay-label').style.display = isAutoPlay ? 'inline-block' : 'none';
            document.getElementById('delay-select').style.display = isAutoPlay ? 'inline-block' : 'none';
            document.getElementById('answer-time-label').style.display = isMemorizationMode ? 'none' : 'inline-block';
            document.getElementById('answer-time-select').style.display = isMemorizationMode ? 'none' : 'inline-block';
            document.getElementById('feedback').textContent = '';
            selectedLetter = null;
            selectedWord = null;

            if (!isMemorizationMode) {
                if (isSingleDigit) {
                    const letters = getRandomOptions(cards.single_digits, 'letter', card.letter, 5);
                    const words = getRandomOptions(cards.single_digits, 'word', card.word, 5);
                    const letterDiv = document.createElement('div');
                    letterDiv.className = 'options-row';
                    letterDiv.style.display = 'flex';
                    letterDiv.style.gap = '10px';
                    letterDiv.style.flexWrap = 'wrap';
                    letterDiv.style.justifyContent = 'center';
                    letters.forEach(letter => {
                        const option = document.createElement('div');
                        option.className = 'option';
                        option.textContent = letter;
                        option.onclick = () => selectOption(option, 'letter', letter);
                        letterDiv.appendChild(option);
                    });
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'options-row';
                    wordDiv.style.display = 'flex';
                    wordDiv.style.gap = '10px';
                    wordDiv.style.flexWrap = 'wrap';
                    wordDiv.style.justifyContent = 'center';
                    words.forEach(word => {
                        const option = document.createElement('div');
                        option.className = 'option';
                        option.textContent = word;
                        option.onclick = () => selectOption(option, 'word', word);
                        wordDiv.appendChild(option);
                    });
                    document.getElementById('options-container').appendChild(letterDiv);
                    document.getElementById('options-container').appendChild(wordDiv);
                } else {
                    const words = getRandomOptions(cards.double_digits, 'word', card.word, 5);
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'options-row';
                    wordDiv.style.display = 'flex';
                    wordDiv.style.gap = '10px';
                    wordDiv.style.flexWrap = 'wrap';
                    wordDiv.style.justifyContent = 'center';
                    words.forEach(word => {
                        const option = document.createElement('div');
                        option.className = 'option';
                        option.textContent = word;
                        option.onclick = () => selectOption(option, 'word', word);
                        wordDiv.appendChild(option);
                    });
                    document.getElementById('options-container').appendChild(wordDiv);
                }
                startAnswerTimer();
            }

            if (isAutoPlay && isMemorizationMode) {
                const delay = parseInt(document.getElementById('delay-select').value);
                autoPlayTimeout = setTimeout(nextCard, delay);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
        function getRandomOptions(sourceArray, key, correctValue, count) {
            const options = [correctValue];
            const available = sourceArray.filter(item => item[key] !== correctValue).map(item => item[key]);
            for (let i = 0; i < count - 1; i++) {
                if (available.length === 0) break;
                const randomIndex = Math.floor(Math.random() * available.length);
                options.push(available.splice(randomIndex, 1)[0]);
            }
            return options.sort(() => Math.random() - 0.5);
        }

        // –í—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞
        function selectOption(element, type, value) {
            if (type === 'letter') {
                if (selectedLetter) {
                    selectedLetter.classList.remove('selected');
                }
                selectedLetter = element;
                selectedLetter.classList.add('selected');
            } else {
                if (selectedWord) {
                    selectedWord.classList.remove('selected');
                }
                selectedWord = element;
                selectedWord.classList.add('selected');
            }

            const card = currentCards[currentCardIndex];
            const isSingleDigit = 'digit' in card;
            if (isSingleDigit && selectedLetter && selectedWord) {
                checkAnswer();
            } else if (!isSingleDigit && selectedWord) {
                checkAnswer();
            }
        }

        // –°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞
        function toggleMode() {
            isMemorizationMode = !isMemorizationMode;
            document.getElementById('mode-title').textContent = isMemorizationMode ? '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞' : '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
            document.getElementById('mode-button').title = isMemorizationMode ? '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
            stopAutoPlay();
            stopAnswerTimer();
            saveSessionStats();
            stats.correct = 0;
            stats.incorrect = 0;
            stats.timeout = 0;
            stats.attempts = [];
            streak = 0;
            updateStatsDisplay();
            showCard();
        }

        // –°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
        function nextCard() {
            const order = document.querySelector('input[name="order"]:checked').value;
            if (order === 'random') {
                currentCardIndex = Math.floor(Math.random() * currentCards.length);
            } else {
                currentCardIndex = (currentCardIndex + 1) % currentCards.length;
            }
            showCard();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
        function checkAnswer() {
            stopAnswerTimer();
            const card = currentCards[currentCardIndex];
            const isSingleDigit = 'digit' in card;
            const correctLetter = isSingleDigit ? card.letter : null;
            const correctWord = card.word;
            const feedback = document.getElementById('feedback');
            const startTime = Date.now();
            let isCorrect = false;

            if (isSingleDigit) {
                isCorrect = selectedLetter?.textContent === correctLetter && selectedWord?.textContent === correctWord;
                feedback.textContent = isCorrect
                    ? '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!'
                    : `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${correctLetter}, ${correctWord}`;
            } else {
                isCorrect = selectedWord?.textContent === correctWord;
                feedback.textContent = isCorrect
                    ? '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!'
                    : `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${correctWord}`;
            }

            feedback.style.color = isCorrect ? 'green' : 'red';
            stats.attempts.push({
                digit: isSingleDigit ? card.digit : card.number,
                isCorrect,
                selectedLetter: selectedLetter?.textContent,
                selectedWord: selectedWord?.textContent,
                time: Date.now() - startTime
            });
            stats[isCorrect ? 'correct' : 'incorrect']++;
            streak = isCorrect ? streak + 1 : 0;
            if (streak === 10) {
                feedback.textContent += ' –û—Ç–ª–∏—á–Ω–æ! 10 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥!';
                setTimeout(() => {
                    if (feedback.textContent.includes('10 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥')) {
                        feedback.textContent = isCorrect ? '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!' : `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${correctWord}`;
                    }
                }, 2000);
            }
            updateStatsDisplay();
            document.getElementById('options-container').innerHTML = '';
            if (isAutoPlay && !isMemorizationMode) {
                const delay = parseInt(document.getElementById('delay-select').value);
                autoPlayTimeout = setTimeout(nextCard, delay);
            }
        }

        // –¢–∞–π–º–µ—Ä –æ—Ç–≤–µ—Ç–∞
        function startAnswerTimer() {
            stopAnswerTimer();
            if (!isMemorizationMode) {
                const answerTime = parseInt(document.getElementById('answer-time-select').value);
                answerTimeout = setTimeout(() => {
                    const card = currentCards[currentCardIndex];
                    const isSingleDigit = 'digit' in card;
                    const correctLetter = isSingleDigit ? card.letter : null;
                    const correctWord = card.word;
                    const feedback = document.getElementById('feedback');
                    feedback.textContent = isSingleDigit
                        ? `–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${correctLetter}, ${correctWord}`
                        : `–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${correctWord}`;
                    feedback.style.color = 'red';
                    stats.timeout++;
                    stats.attempts.push({
                        digit: isSingleDigit ? card.digit : card.number,
                        isCorrect: false,
                        selectedLetter: null,
                        selectedWord: null,
                        time: answerTime
                    });
                    streak = 0;
                    updateStatsDisplay();
                    document.getElementById('options-container').innerHTML = '';
                    if (isAutoPlay) {
                        const delay = parseInt(document.getElementById('delay-select').value);
                        autoPlayTimeout = setTimeout(nextCard, delay);
                    }
                }, answerTime);
            }
        }

        function stopAnswerTimer() {
            if (answerTimeout) {
                clearTimeout(answerTimeout);
                answerTimeout = null;
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ–º
        function toggleAutoPlay() {
            isAutoPlay = !isAutoPlay;
            const autoButton = document.getElementById('auto-button');
            autoButton.textContent = isAutoPlay ? '‚è∏' : '‚ñ∂';
            autoButton.title = isAutoPlay ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ' : '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ';
            document.getElementById('next-button').style.display = isAutoPlay ? 'none' : 'block';
            document.getElementById('delay-label').style.display = isAutoPlay ? 'inline-block' : 'none';
            document.getElementById('delay-select').style.display = isAutoPlay ? 'inline-block' : 'none';
            if (isAutoPlay) {
                if (isMemorizationMode) {
                    const delay = parseInt(document.getElementById('delay-select').value);
                    autoPlayTimeout = setTimeout(nextCard, delay);
                } else {
                    checkAnswer();
                }
            } else {
                stopAutoPlay();
                stopAnswerTimer();
            }
        }

        function stopAutoPlay() {
            isAutoPlay = false;
            const autoButton = document.getElementById('auto-button');
            autoButton.textContent = '‚ñ∂';
            autoButton.title = '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ';
            document.getElementById('next-button').style.display = 'block';
            document.getElementById('delay-label').style.display = 'none';
            document.getElementById('delay-select').style.display = 'none';
            if (autoPlayTimeout) {
                clearTimeout(autoPlayTimeout);
                autoPlayTimeout = null;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatsDisplay() {
            const total = stats.correct + stats.incorrect + stats.timeout;
            const accuracy = total > 0 ? ((stats.correct / total) * 100).toFixed(1) : 0;
            document.getElementById('feedback').textContent = total > 0
                ? `–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${stats.correct}, –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: ${stats.incorrect}, –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ: ${stats.timeout}, –¢–æ—á–Ω–æ—Å—Ç—å: ${accuracy}%`
                : '';
        }

        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function showStats() {
            saveSessionStats();
            const modal = document.getElementById('modal');
            const summary = document.getElementById('stats-summary');
            const total = stats.correct + stats.incorrect + stats.timeout;
            const accuracy = total > 0 ? ((stats.correct / total) * 100).toFixed(1) : 0;
            summary.innerHTML = `
                <p>–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${stats.correct}</p>
                <p>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: ${stats.incorrect}</p>
                <p>–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ: ${stats.timeout}</p>
                <p>–¢–æ—á–Ω–æ—Å—Ç—å: ${accuracy}%</p>
                <p>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${calculateAverageTime().toFixed(1)} –º—Å</p>
                <h4>–û—à–∏–±–∫–∏:</h4>
                <ul>${generateErrorList()}</ul>
            `;

            // –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
            const ctx = document.getElementById('stats-chart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['–ü—Ä–∞–≤–∏–ª—å–Ω–æ', '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ', '–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ'],
                    datasets: [{
                        data: [stats.correct, stats.incorrect, stats.timeout],
                        backgroundColor: ['#4CAF50', '#EF4444', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // –ò—Å—Ç–æ—Ä–∏—è
            const historyBody = document.getElementById('history-table-body');
            historyBody.innerHTML = '';
            stats.history.forEach((session, index) => {
                const sessionTotal = session.correct + session.incorrect + session.timeout;
                const sessionAccuracy = sessionTotal > 0 ? ((session.correct / sessionTotal) * 100).toFixed(1) : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(session.date).toLocaleString()}</td>
                    <td>${session.correct}</td>
                    <td>${session.incorrect}</td>
                    <td>${session.timeout}</td>
                    <td>${sessionAccuracy}%</td>
                `;
                historyBody.appendChild(row);
            });

            // –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –∏—Å—Ç–æ—Ä–∏–∏
            const historyCtx = document.getElementById('history-chart').getContext('2d');
            const historyData = stats.history.map(session => {
                const sessionTotal = session.correct + session.incorrect + session.timeout;
                return sessionTotal > 0 ? (session.correct / sessionTotal) * 100 : 0;
            });
            new Chart(historyCtx, {
                type: 'line',
                data: {
                    labels: stats.history.map((_, i) => `–°–µ—Å—Å–∏—è ${i + 1}`),
                    datasets: [{
                        label: '–¢–æ—á–Ω–æ—Å—Ç—å (%)',
                        data: historyData,
                        borderColor: '#3B82F6',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            modal.style.display = 'flex';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            const ctx = document.getElementById('stats-chart').getContext('2d');
            ctx.canvas.parentNode.removeChild(ctx.canvas);
            const newCanvas = document.createElement('canvas');
            newCanvas.id = 'stats-chart';
            newCanvas.style.maxWidth = '100%';
            newCanvas.style.height = '200px';
            document.getElementById('current-stats').appendChild(newCanvas);
            const historyCtx = document.getElementById('history-chart').getContext('2d');
            historyCtx.canvas.parentNode.removeChild(historyCtx.canvas);
            const newHistoryCanvas = document.createElement('canvas');
            newHistoryCanvas.id = 'history-chart';
            newHistoryCanvas.style.maxWidth = '100%';
            newHistoryCanvas.style.height = '200px';
            document.getElementById('history-stats').insertBefore(newHistoryCanvas, document.getElementById('stats-table'));
        }

        // –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
        function calculateAverageTime() {
            const times = stats.attempts.map(attempt => attempt.time).filter(time => time !== undefined);
            return times.length > 0 ? times.reduce((sum, time) => sum + time, 0) / times.length : 0;
        }

        // –°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
        function generateErrorList() {
            const errors = stats.attempts.filter(attempt => !attempt.isCorrect);
            const errorMap = {};
            errors.forEach(attempt => {
                const key = attempt.digit;
                if (!errorMap[key]) {
                    errorMap[key] = { count: 0, details: [] };
                }
                errorMap[key].count++;
                errorMap[key].details.push(`–í—ã–±—Ä–∞–Ω–æ: ${attempt.selectedLetter || '-'}, ${attempt.selectedWord || '-'}`);
            });
            return Object.entries(errorMap).map(([digit, data]) => `
                <li>–¶–∏—Ñ—Ä–∞ ${digit}: ${data.count} –æ—à–∏–±${data.count === 1 ? '–∫–∞' : '–∫–∏'} (${data.details.join('; ')})</li>
            `).join('');
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Å—Å–∏–∏
        function saveSessionStats() {
            const total = stats.correct + stats.incorrect + stats.timeout;
            if (total > 0) {
                stats.history.push({
                    date: new Date().toISOString(),
                    correct: stats.correct,
                    incorrect: stats.incorrect,
                    timeout: stats.timeout,
                    attempts: stats.attempts
                });
                if (stats.history.length > 10) {
                    stats.history.shift();
                }
                localStorage.setItem('statsHistory', JSON.stringify(stats.history));
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        function exportStats() {
            const csv = [
                '–î–∞—Ç–∞,–ü—Ä–∞–≤–∏–ª—å–Ω–æ,–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ,–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ,–¢–æ—á–Ω–æ—Å—Ç—å,–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–º—Å)',
                ...stats.history.map(session => {
                    const total = session.correct + session.incorrect + session.timeout;
                    const accuracy = total > 0 ? ((session.correct / total) * 100).toFixed(1) : 0;
                    const avgTime = session.attempts.map(a => a.time).filter(t => t !== undefined).reduce((sum, t) => sum + t, 0) / session.attempts.length || 0;
                    return `${new Date(session.date).toLocaleString()},${session.correct},${session.incorrect},${session.timeout},${accuracy},${avgTime.toFixed(1)}`;
                })
            ].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stats.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // –°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function resetStats() {
            stats.history = [];
            localStorage.removeItem('statsHistory');
            stats.correct = 0;
            stats.incorrect = 0;
            stats.timeout = 0;
            stats.attempts = [];
            streak = 0;
            updateStatsDisplay();
            closeModal();
        }
    </script>
</body>
</html>